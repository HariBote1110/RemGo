# Fooocus カスタムフォーク統合開発計画書

## 1. プロジェクト目標

Windowsのリソース（マルチGPU）を最大限に活用し、Macなどのクライアント端末からReact UIを通じて、セッションの中断・復帰が自在な高効率生成環境を構築する。

## 2. システム構成図（統合版）

* **Backend (Windows):** Python (FastAPI) + Fooocus Core
* 各GPUごとに独立したワーカープロセスを起動。
* 生成命令、状態取得、ファイル管理のAPIを提供。


* **Frontend (Mac/Remote):** React App
* `LocalStorage` による入力状態の永続化。
* WebSocketによるリアルタイム進捗監視。
* 複数GPUを切り替えて操作するマルチインスタンスUI。



---

## 3. 実装計画

### フェーズ 1: ステートの永続化とセッション復元

* **Frontend-side Persistence:**
* Reactのステート（プロンプト、モデル設定、Sampler等）を `Zustand` や `Redux-persist` を用いてブラウザの `LocalStorage` に同期。
* ブラウザをリロード、または一度閉じても、前回の設定が即座に復元される仕組みを構築。


* **Backend-side Session Context:**
* 生成中のパラメータをサーバー側のJSONファイルにキャッシュ。
* 万が一のバックエンド再起動時も、最後に使用していた設定をAPI経由でフロントに提供できる冗長性。



### フェーズ 2: マルチGPU・マルチセッション管理

* **GPUインスタンスの並列化:**
* Windows側で、`CUDA_VISIBLE_DEVICES` を指定して複数のAPIインスタンスを起動（例: Port 8000 = GPU 0, Port 8001 = GPU 1）。


* **React Multi-Session UI:**
* UIの上部に「GPU Selector」を実装。
* 選択中のGPU（APIエンドポイント）ごとに、React側のステートを独立させて保持。これにより、GPU 0で生成中に、GPU 1の設定を別のタブで調整することが可能に。



### フェーズ 3: リモート操作の最適化

* **アセット配信の高速化:**
* 生成された画像のプレビューを軽量化（WebP形式への変換等）して送信し、Mac側の表示レスポンスを向上。


* **ネットワーク設定の固定:**
* Windows側のホスト名（mDNS）によるアクセスを確立し、IPアドレス変動の影響を排除。



---

## 4. 今後の具体的な作業タスク

1. **APIエンドポイントの拡張:**
* 現在のReact UIが接続しているAPIに、使用可能なGPUリストを返す `/system/gpus` や、インスタンスの状態を取得するエンドポイントを追加。


2. **ステート同期ロジックの強化:**
* 入力フォームの `onChange` イベントにデバウンス（Debounce）をかけ、頻繁な保存による負荷を抑えつつ `LocalStorage` へ書き込む処理を実装。


3. **マルチプロセスマネージャーの作成:**
* Windows側で複数のAPIサーバーを一括起動・管理するためのシンプルなスクリプト（PythonまたはBatch）の整備。



---

## 5. 運用上の留意点

* **パスの互換性:** ファイルブラウザ機能を実装する場合、Windowsのバックスラッシュ `\` とMacの `/` の違いをバックエンド側で吸収する。
* **セキュリティ:** リモートからのアクセスになるため、必要に応じてAPIに簡単なAPIキー認証を追加することを推奨。
